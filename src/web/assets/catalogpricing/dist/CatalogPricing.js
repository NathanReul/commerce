!function(){function t(i){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(i)}"undefined"===t(Craft.Commerce)&&(Craft.Commerce={}),Craft.Commerce.CatalogPricing=Garnish.Base.extend({$catalogPricingRules:null,$clearSearchBtn:null,$filterBtn:null,$search:null,$searchContainer:null,$tableContainer:null,filterHuds:{},searchTimeout:null,searching:!1,view:null,defaults:{},init:function(t,i,e){var a=this;this.view=t,this.$tableContainer=i,this.$searchContainer=this.view.find(".search-container:first"),this.$search=this.$searchContainer.find("input:first"),this.$clearSearchBtn=this.$searchContainer.children(".clear-btn:first"),this.$filterBtn=this.$searchContainer.children(".filter-btn:first"),this.setSettings(e,this.defaults),this.settings.filterBtnActive&&this.$filterBtn.addClass("active"),this.addListener(this.$filterBtn,"click","showFilterHud"),this.addListener(this.$search,"input",(function(){!a.searching&&a.$search.val()?a.startSearching():a.searching&&!a.$search.val()&&a.stopSearching(),a.searchTimeout&&clearTimeout(a.searchTimeout),a.searchTimeout=setTimeout(a.updateTableIfSearchTextChanged.bind(a),500)})),this.addListener(this.$clearSearchBtn,"click",(function(){a.clearSearch(!0),Garnish.isMobileBrowser(!0)||a.$search.trigger("focus")})),this.iniCatalogPriceRules()},startSearching:function(){this.$clearSearchBtn.removeClass("hidden"),this.searching=!0},clearSearch:function(t){this.searching&&(this.$search.val(""),this.searchTimeout&&clearTimeout(this.searchTimeout),this.stopSearching(),t?this.updateTableIfSearchTextChanged():this.searchText=null)},stopSearching:function(){this.$clearSearchBtn.addClass("hidden"),this.searching=!1},showFilterHud:function(){this.getFilterHud()?this.getFilterHud().show():(this.createFilterHud(),this.updateFilterBtn())},updateFilterBtn:function(){this.$filterBtn.removeClass("active"),this.getFilterHud()?(this.$filterBtn.attr("aria-controls",this.getFilterHud().id).attr("aria-expanded",this.getFilterHud().showing?"true":"false"),(this.getFilterHud().showing||this.getFilterHud().hasRules())&&this.$filterBtn.addClass("active")):this.$filterBtn.attr("aria-controls",null)},serializeConditionForm:function(){if(!this.getFilterHud())return null;var t=this.getFilterHud().$body.find(".condition-container:first"),i={};return $.map(t.serializeArray(),(function(t){var e=t.name.match(/[a-zA-Z0-9_\\]+|(?=\[\])/g);if(e.length>1){for(var a=i,n=e.pop(),s=0;s<e.length;s++){var r=e[s];a[r]=a[r]?a[r]:""==n?[]:{},a=a[r]}""==n?(a=Array.isArray(a)?a:[]).push(t.value):a[n]=t.value}else i[e.pop()]=t.value})),i},getFilterHudKey:function(){return"site-".concat(this.settings.siteId)},createFilterHud:function(){this.filterHuds[this.getFilterHudKey()]=new Craft.Commerce.CatalogPricingHud(this,this.settings.siteId)},getFilterHud:function(){return-1===Object.keys(this.filterHuds).indexOf(this.getFilterHudKey())?null:this.filterHuds[this.getFilterHudKey()]},destroyFilterHud:function(){this.getFilterHud()&&delete this.filterHuds[this.getFilterHudKey()]},updateTableIfSearchTextChanged:function(){this.searchText!==(this.searchText=this.searching?this.$search.val():null)&&this.updateTable()},updateTable:function(){var t=this,i={searchText:this.$search.val(),siteId:this.settings.siteId,condition:this.serializeConditionForm()};Craft.sendActionRequest("POST","commerce/catalog-pricing/prices",{data:i}).then((function(i){t.removeCatalogPricingRuleListeners(),i.data&&i.data.tableHtml&&(Craft.appendHeadHtml(i.data.headHtml),Craft.appendBodyHtml(i.data.bodyHtml),t.$tableContainer.html(i.data.tableHtml),t.iniCatalogPriceRules())}))},removeCatalogPricingRuleListeners:function(){this.$catalogPricingRules.off("click")},iniCatalogPriceRules:function(){this.$catalogPricingRules=this.view.find(".js-cpr-slideout"),this.$catalogPricingRules.on("click",(function(t){t.preventDefault(),new Craft.CpScreenSlideout("commerce/catalog-pricing-rules/slideout",{params:{storeId:$(this).data("store-id"),purchasableId:$(this).data("purchasable-id"),id:$(this).data("catalog-pricing-rule-id")}}).on("submit",(function(t){var i=t.response,e=t.data;console.log(i,e)}))}))}}),Craft.Commerce.CatalogPricingHud=Garnish.HUD.extend({view:null,siteId:null,id:null,loading:!0,serialized:null,$clearBtn:null,cleared:!1,init:function(t,i){var e=this;this.view=t,this.siteId=i,this.id="filter-".concat(Math.floor(1e9*Math.random()));var a=$("<div/>").append($("<div/>",{class:"spinner"})).append($("<div/>",{text:Craft.t("app","Loading"),class:"visually-hidden","aria-role":"alert"}));this.base(this.view.$filterBtn,a,{hudClass:"hud element-filter-hud loading"}),this.$hud.attr({id:this.id,"aria-live":"polite","aria-busy":"false"}),this.$tip.remove(),this.$tip=null,this.$body.on("submit",(function(t){t.preventDefault(),e.hide()})),Craft.sendActionRequest("POST","commerce/catalog-pricing/filter",{data:{condition:this.view.settings.condition,id:"".concat(this.id,"-filters")}}).then((function(t){e.loading=!1,e.$hud.removeClass("loading"),a.remove(),e.$main.append(t.data.hudHtml),Craft.appendHeadHtml(t.data.headHtml),Craft.appendBodyHtml(t.data.bodyHtml),e.view.settings.condition=t.data.condition,e.serialized=e.view.serializeConditionForm();var i=$("<div/>",{class:"flex flex-nowrap"}).appendTo(e.$main);$("<div/>",{class:"flex-grow"}).appendTo(i),e.$clearBtn=$("<button/>",{type:"button",class:"btn",text:Craft.t("app","Cancel")}).appendTo(i),$("<button/>",{type:"submit",class:"btn secondary",text:Craft.t("app","Apply")}).appendTo(i),e.$clearBtn.on("click",(function(){e.clear()})),e.$hud.find(".condition-container").on("htmx:beforeRequest",(function(){e.setBusy()})),e.$hud.find(".condition-container").on("htmx:load",(function(){e.setReady(),e.updateSizeAndPosition(!0)})),e.setFocus()})).catch((function(){Craft.cp.displayError(Craft.t("app","A server error occurred."))})),this.$hud.css("position","fixed"),this.addListener(Garnish.$win,"scroll,resize",(function(){e.updateSizeAndPosition(!0)}))},addListener:function(t,i,e,a){t===this.$main&&"resize"===i||this.base(t,i,e,a)},setBusy:function(){this.$hud.attr("aria-busy","true"),$("<div/>",{class:"visually-hidden",text:Craft.t("app","Loading")}).insertAfter(this.$main.find(".htmx-indicator"))},setReady:function(){this.$hud.attr("aria-busy","false")},setFocus:function(){Garnish.setFocusWithin(this.$main)},clear:function(){this.cleared=!0,this.destroy(),this.hide()},updateSizeAndPositionInternal:function(){var t,i=this.view.$searchContainer[0].getBoundingClientRect(),e=Garnish.$win.height(),a=e-i.bottom;this.$body.height()>a&&(t=e-i.bottom-10),this.$hud.css({width:this.view.$searchContainer.outerWidth()-2,top:i.top+this.view.$searchContainer.outerHeight(),left:i.left+1,height:t?"".concat(t,"px"):"unset",overflowY:t?"scroll":"unset"})},onShow:function(){this.base(),this.$clearBtn&&this.hasRules()?this.$clearBtn.text(Craft.t("app","Clear")):this.$clearBtn&&!this.hasRules()&&this.$clearBtn.text(Craft.t("app","Cancel")),this.view.updateFilterBtn(),this.setFocus()},onHide:function(){this.base(),this.serialized!==(this.serialized=this.view.serializeConditionForm())&&this.view.updateTable(),this.cleared||(this.$hud.detach(),this.$shade.detach()),this.view.updateFilterBtn(),this.view.$filterBtn.focus()},hasRules:function(){return 0!==this.$main.has(".condition-rule").length},destroy:function(){this.base(),this.view.getFilterHud()&&this.view.destroyFilterHud()}})}();
//# sourceMappingURL=CatalogPricing.js.map