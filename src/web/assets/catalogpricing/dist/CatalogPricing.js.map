{"version":3,"file":"CatalogPricing.js","mappings":"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","sources":["webpack:///./js/CatalogPricing.js"],"sourcesContent":["/* jshint esversion: 6 */\n/* globals Craft, Garnish, $ */\nif (typeof Craft.Commerce === typeof undefined) {\n  Craft.Commerce = {};\n}\n\nCraft.Commerce.CatalogPricing = Garnish.Base.extend({\n  $clearSearchBtn: null,\n  $filterBtn: null,\n  $search: null,\n  $searchContainer: null,\n  $tableContainer: null,\n  filterHuds: {},\n  searchTimeout: null,\n  searching: false,\n  view: null,\n  defaults: {},\n\n  init: function (view, tableContainer, settings) {\n    this.view = view;\n    this.$tableContainer = tableContainer;\n    this.$searchContainer = this.view.find('.search-container:first');\n    this.$search = this.$searchContainer.find('input:first');\n    this.$clearSearchBtn = this.$searchContainer.children('.clear-btn:first');\n    this.$filterBtn = this.$searchContainer.children('.filter-btn:first');\n    this.setSettings(settings, this.defaults);\n\n    this.addListener(this.$filterBtn, 'click', 'showFilterHud');\n\n    this.addListener(this.$search, 'input', () => {\n      if (!this.searching && this.$search.val()) {\n        this.startSearching();\n      } else if (this.searching && !this.$search.val()) {\n        this.stopSearching();\n      }\n\n      if (this.searchTimeout) {\n        clearTimeout(this.searchTimeout);\n      }\n\n      this.searchTimeout = setTimeout(\n        this.updateTableIfSearchTextChanged.bind(this),\n        500\n      );\n    });\n\n    // Clear the search when the X button is clicked\n    this.addListener(this.$clearSearchBtn, 'click', () => {\n      this.clearSearch(true);\n\n      if (!Garnish.isMobileBrowser(true)) {\n        this.$search.trigger('focus');\n      }\n    });\n  },\n\n  startSearching: function () {\n    // Show the clear button\n    this.$clearSearchBtn.removeClass('hidden');\n    this.searching = true;\n  },\n\n  clearSearch: function (updateTable) {\n    if (!this.searching) {\n      return;\n    }\n\n    this.$search.val('');\n\n    if (this.searchTimeout) {\n      clearTimeout(this.searchTimeout);\n    }\n\n    this.stopSearching();\n\n    if (updateTable) {\n      this.updateTableIfSearchTextChanged();\n    } else {\n      this.searchText = null;\n    }\n  },\n\n  stopSearching: function () {\n    // Hide the clear button\n    this.$clearSearchBtn.addClass('hidden');\n    this.searching = false;\n  },\n\n  showFilterHud: function () {\n    if (!this.getFilterHud()) {\n      this.createFilterHud();\n      this.updateFilterBtn();\n    } else {\n      this.getFilterHud().show();\n    }\n  },\n\n  updateFilterBtn: function () {\n    this.$filterBtn.removeClass('active');\n\n    if (this.getFilterHud()) {\n      this.$filterBtn\n        .attr('aria-controls', this.getFilterHud().id)\n        .attr('aria-expanded', this.getFilterHud().showing ? 'true' : 'false');\n\n      if (this.getFilterHud().showing || this.getFilterHud().hasRules()) {\n        this.$filterBtn.addClass('active');\n      }\n    } else {\n      this.$filterBtn.attr('aria-controls', null);\n    }\n  },\n\n  serializedCondition: function () {\n    if (this.getFilterHud()) {\n      return this.getFilterHud()\n        .$body.find('.condition-container:first')\n        .serialize();\n    }\n\n    return null;\n  },\n\n  getFilterHudKey: function () {\n    return `site-${this.settings.siteId}`;\n  },\n\n  createFilterHud: function () {\n    this.filterHuds[this.getFilterHudKey()] =\n      new Craft.Commerce.CatalogPricingHud(this, this.settings.siteId);\n  },\n\n  getFilterHud: function () {\n    if (Object.keys(this.filterHuds).indexOf(this.getFilterHudKey()) === -1) {\n      return null;\n    }\n\n    return this.filterHuds[this.getFilterHudKey()];\n  },\n\n  destroyFilterHud: function () {\n    if (this.getFilterHud()) {\n      delete this.filterHuds[this.getFilterHudKey()];\n    }\n  },\n\n  updateTableIfSearchTextChanged: function () {\n    if (\n      this.searchText !==\n      (this.searchText = this.searching ? this.$search.val() : null)\n    ) {\n      this.updateTable();\n    }\n  },\n\n  updateTable: function () {\n    let params = {\n      searchText: this.$search.val(),\n      siteId: this.settings.siteId,\n      condition: this.serializedCondition(),\n    };\n\n    Craft.sendActionRequest('POST', 'commerce/catalog-pricing/prices', {\n      data: params,\n    }).then((response) => {\n      if (response.data && response.data.tableHtml) {\n        Craft.appendHeadHtml(response.data.headHtml);\n        Craft.appendBodyHtml(response.data.bodyHtml);\n\n        this.$tableContainer.html(response.data.tableHtml);\n      }\n    });\n  },\n});\n\nCraft.Commerce.CatalogPricingHud = Garnish.HUD.extend({\n  view: null,\n  siteId: null,\n  id: null,\n  loading: true,\n  serialized: null,\n  $clearBtn: null,\n  cleared: false,\n\n  init: function (view, siteId) {\n    this.view = view;\n\n    this.siteId = siteId;\n    this.id = `filter-${Math.floor(Math.random() * 1000000000)}`;\n\n    const $loadingContent = $('<div/>')\n      .append(\n        $('<div/>', {\n          class: 'spinner',\n        })\n      )\n      .append(\n        $('<div/>', {\n          text: Craft.t('app', 'Loading'),\n          class: 'visually-hidden',\n          'aria-role': 'alert',\n        })\n      );\n\n    this.base(this.view.$filterBtn, $loadingContent, {\n      hudClass: 'hud element-filter-hud loading',\n    });\n\n    this.$hud.attr({\n      id: this.id,\n      'aria-live': 'polite',\n      'aria-busy': 'false',\n    });\n    this.$tip.remove();\n    this.$tip = null;\n\n    this.$body.on('submit', (ev) => {\n      ev.preventDefault();\n      this.hide();\n    });\n\n    Craft.sendActionRequest('POST', 'commerce/catalog-pricing/filter', {\n      data: {\n        condition: this.view.settings.condition,\n        id: `${this.id}-filters`,\n      },\n    })\n      .then((response) => {\n        this.loading = false;\n        this.$hud.removeClass('loading');\n        $loadingContent.remove();\n\n        this.$main.append(response.data.hudHtml);\n        Craft.appendHeadHtml(response.data.headHtml);\n        Craft.appendBodyHtml(response.data.bodyHtml);\n\n        const $btnContainer = $('<div/>', {\n          class: 'flex flex-nowrap',\n        }).appendTo(this.$main);\n        $('<div/>', {\n          class: 'flex-grow',\n        }).appendTo($btnContainer);\n        this.$clearBtn = $('<button/>', {\n          type: 'button',\n          class: 'btn',\n          text: Craft.t('app', 'Cancel'),\n        }).appendTo($btnContainer);\n        $('<button/>', {\n          type: 'submit',\n          class: 'btn secondary',\n          text: Craft.t('app', 'Apply'),\n        }).appendTo($btnContainer);\n        this.$clearBtn.on('click', () => {\n          this.clear();\n        });\n\n        this.$hud.find('.condition-container').on('htmx:beforeRequest', () => {\n          this.setBusy();\n        });\n\n        this.$hud.find('.condition-container').on('htmx:load', () => {\n          this.setReady();\n          this.updateSizeAndPosition(true);\n        });\n        this.setFocus();\n      })\n      .catch(() => {\n        Craft.cp.displayError(Craft.t('app', 'A server error occurred.'));\n      });\n\n    this.$hud.css('position', 'fixed');\n\n    this.addListener(Garnish.$win, 'scroll,resize', () => {\n      this.updateSizeAndPosition(true);\n    });\n  },\n\n  addListener: function (elem, events, data, func) {\n    if (elem === this.$main && events === 'resize') {\n      return;\n    }\n    this.base(elem, events, data, func);\n  },\n\n  setBusy: function () {\n    this.$hud.attr('aria-busy', 'true');\n\n    $('<div/>', {\n      class: 'visually-hidden',\n      text: Craft.t('app', 'Loading'),\n    }).insertAfter(this.$main.find('.htmx-indicator'));\n  },\n\n  setReady: function () {\n    this.$hud.attr('aria-busy', 'false');\n  },\n\n  setFocus: function () {\n    Garnish.setFocusWithin(this.$main);\n  },\n\n  clear: function () {\n    this.cleared = true;\n    this.destroy();\n    this.hide();\n  },\n\n  updateSizeAndPositionInternal: function () {\n    const searchOffset = this.view.$searchContainer[0].getBoundingClientRect();\n\n    // Ensure HUD is scrollable if content falls off-screen\n    const windowHeight = Garnish.$win.height();\n    let hudHeight;\n    const availableSpace = windowHeight - searchOffset.bottom;\n\n    if (this.$body.height() > availableSpace) {\n      hudHeight = windowHeight - searchOffset.bottom - 10;\n    }\n\n    this.$hud.css({\n      width: this.view.$searchContainer.outerWidth() - 2,\n      top: searchOffset.top + this.view.$searchContainer.outerHeight(),\n      left: searchOffset.left + 1,\n      height: hudHeight ? `${hudHeight}px` : 'unset',\n      overflowY: hudHeight ? 'scroll' : 'unset',\n    });\n  },\n\n  onShow: function () {\n    this.base();\n\n    // Cancel => Clear\n    if (this.$clearBtn && this.hasRules()) {\n      this.$clearBtn.text(Craft.t('app', 'Clear'));\n    }\n\n    this.view.updateFilterBtn();\n    this.setFocus();\n  },\n\n  onHide: function () {\n    this.base();\n\n    // If something changed, update the elements\n    if (this.serialized !== (this.serialized = this.serialize())) {\n      this.view.updateTable();\n    }\n\n    if (!this.cleared) {\n      this.$hud.detach();\n      this.$shade.detach();\n    }\n\n    this.view.updateFilterBtn();\n    this.view.$filterBtn.focus();\n  },\n\n  hasRules: function () {\n    return this.$main.has('.condition-rule').length !== 0;\n  },\n\n  serialize: function () {\n    if (this.cleared || !this.hasRules()) {\n      return null;\n    }\n\n    return this.view.serializedCondition();\n  },\n\n  destroy: function () {\n    this.base();\n\n    if (this.view.getFilterHud()) {\n      this.view.destroyFilterHud();\n    }\n  },\n});\n"],"names":["Craft","Commerce","CatalogPricing","Garnish","Base","extend","$clearSearchBtn","$filterBtn","$search","$searchContainer","$tableContainer","filterHuds","searchTimeout","searching","view","defaults","init","tableContainer","settings","this","find","children","setSettings","addListener","val","startSearching","stopSearching","clearTimeout","setTimeout","updateTableIfSearchTextChanged","bind","clearSearch","isMobileBrowser","trigger","removeClass","updateTable","searchText","addClass","showFilterHud","getFilterHud","show","createFilterHud","updateFilterBtn","attr","id","showing","hasRules","serializedCondition","$body","serialize","getFilterHudKey","siteId","CatalogPricingHud","Object","keys","indexOf","destroyFilterHud","params","condition","sendActionRequest","data","then","response","tableHtml","appendHeadHtml","headHtml","appendBodyHtml","bodyHtml","html","HUD","loading","serialized","$clearBtn","cleared","Math","floor","random","$loadingContent","$","append","class","text","t","base","hudClass","$hud","$tip","remove","on","ev","preventDefault","hide","$main","hudHtml","$btnContainer","appendTo","type","clear","setBusy","setReady","updateSizeAndPosition","setFocus","cp","displayError","css","$win","elem","events","func","insertAfter","setFocusWithin","destroy","updateSizeAndPositionInternal","hudHeight","searchOffset","getBoundingClientRect","windowHeight","height","availableSpace","bottom","width","outerWidth","top","outerHeight","left","overflowY","onShow","onHide","detach","$shade","focus","has","length"],"sourceRoot":""}